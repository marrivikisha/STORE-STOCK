<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rustaq Store Management</title>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1e40af 0%, #dc2626 100%);
      color: #1f2937;
    }

    .app-wrapper {
      width: 100%;
      height: 100%;
      overflow: auto;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header h1 {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.95;
    }

    .download-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .download-section h3 {
      color: #1e40af;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
    }

    .download-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .download-btn {
      background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
      color: white;
      border: none;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(22,163,74,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .download-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(22,163,74,0.4);
    }

    .download-btn.excel {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
    }

    .download-btn.pdf {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
    }

    .download-btn span {
      font-size: 20px;
    }

    .download-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .stat-icon {
      font-size: 48px;
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    }

    .stat-card.red .stat-icon {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
    }

    .stat-card.green .stat-icon {
      background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
    }

    .stat-card.orange .stat-icon {
      background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
    }

    .stat-info h3 {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .stat-info p {
      font-size: 28px;
      font-weight: bold;
      color: #1f2937;
    }

    .main-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      min-height: 500px;
    }

    .module-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .module-btn {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      border: none;
      padding: 20px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(30,64,175,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .module-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(30,64,175,0.4);
    }

    .module-btn.active {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
      box-shadow: 0 6px 15px rgba(220,38,38,0.4);
    }

    .module-btn span {
      font-size: 24px;
    }

    .module-content {
      display: none;
    }

    .module-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-section {
      background: #f9fafb;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 25px;
      border: 2px solid #e5e7eb;
    }

    .form-section h3 {
      color: #1e40af;
      margin-bottom: 20px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      margin-bottom: 5px;
      color: #374151;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px 12px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #1e40af;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #1e40af;
      color: white;
      box-shadow: 0 2px 8px rgba(30,64,175,0.3);
    }

    .btn-primary:hover:not(:disabled) {
      background: #1e3a8a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(30,64,175,0.4);
    }

    .btn-success {
      background: #16a34a;
      color: white;
    }

    .btn-success:hover {
      background: #15803d;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
      box-shadow: 0 2px 8px rgba(220,38,38,0.3);
    }

    .btn-danger:hover:not(:disabled) {
      background: #b91c1c;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: linear-gradient(135deg, #1e40af 0%, #dc2626 100%);
      color: white;
    }

    th {
      padding: 12px;
      text-align: left;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-valid {
      background: #dcfce7;
      color: #166534;
    }

    .badge-expired {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-rejected {
      background: #f3f4f6;
      color: #374151;
    }

    .badge-import {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-export {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-gave {
      background: #fecaca;
      color: #7f1d1d;
    }

    .badge-return {
      background: #fed7aa;
      color: #7c2d12;
    }

    .badge-received {
      background: #d1fae5;
      color: #065f46;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
    }

    .alert-warning {
      background: #fef3c7;
      color: #92400e;
      border: 2px solid #fbbf24;
    }

    .alert-danger {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
    }

    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border: 2px solid #3b82f6;
    }

    .alert-success {
      background: #dcfce7;
      color: #166534;
      border: 2px solid #22c55e;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .summary-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      text-align: center;
    }

    .summary-card .number {
      font-size: 32px;
      font-weight: bold;
      color: #1e40af;
      margin-bottom: 5px;
    }

    .summary-card .label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
    }

    .days-remaining {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .days-critical {
      background: #fee2e2;
      color: #991b1b;
    }

    .days-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .days-good {
      background: #dcfce7;
      color: #166534;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 15px;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: #6b7280;
    }

    .empty-state p {
      font-size: 14px;
    }

    .photo-upload {
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }

    .photo-upload:hover {
      border-color: #1e40af;
      background: #eff6ff;
    }

    .photo-upload input[type="file"] {
      display: none;
    }

    .photo-preview {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .photo-preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }

    .photo-thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      border: 2px solid #e5e7eb;
      cursor: pointer;
    }

    .photo-thumbnail:hover {
      border-color: #1e40af;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header h1 {
        font-size: 24px;
      }

      .main-content {
        padding: 15px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .module-btn {
        font-size: 14px;
        padding: 15px;
      }

      table {
        font-size: 11px;
      }

      th, td {
        padding: 8px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-wrapper">
   <div class="container">
    <div class="header">
     <h1>üìä RUSTAQ STORE MANAGEMENT</h1>
     <p>Comprehensive inventory and tool management solution</p>
    </div>
    <div class="dashboard">
     <div class="stat-card" onclick="showModule('import-export')">
      <div class="stat-icon">
       üì¶
      </div>
      <div class="stat-info">
       <h3>Transactions</h3>
       <p id="totalTransactions">0</p>
      </div>
     </div>
     <div class="stat-card red" onclick="showModule('stock')">
      <div class="stat-icon">
       üìä
      </div>
      <div class="stat-info">
       <h3>Store Stock</h3>
       <p id="totalStock">0</p>
      </div>
     </div>
     <div class="stat-card green" onclick="showModule('arrivals')">
      <div class="stat-icon">
       üÜï
      </div>
      <div class="stat-info">
       <h3>New Arrivals</h3>
       <p id="totalArrivals">0</p>
      </div>
     </div>
     <div class="stat-card orange" onclick="showModule('calibration')">
      <div class="stat-icon">
       üîß
      </div>
      <div class="stat-info">
       <h3>Calibrations</h3>
       <p id="totalCalibrations">0</p>
      </div>
     </div>
    </div>
    <div class="main-content">
     <div class="module-selector"><button class="module-btn active" onclick="showModule('import-export')"> <span>üì¶</span> Import &amp; Export </button> <button class="module-btn" onclick="showModule('stock')"> <span>üìä</span> Store Stock </button> <button class="module-btn" onclick="showModule('arrivals')"> <span>üÜï</span> New Arrivals </button> <button class="module-btn" onclick="showModule('calibration')"> <span>üîß</span> Tool Calibration </button>
     </div><!-- Import & Export Module -->
     <div id="import-export" class="module-content active">
      <div class="form-section">
       <h3>üì¶ Import &amp; Export Entry</h3>
       <form id="importExportForm">
        <div class="form-grid">
         <div class="form-group"><label>Date *</label> <input type="date" id="ie-date" required>
         </div>
         <div class="form-group"><label>Team Name *</label> <select id="ie-team" required> <option value="">Select Team</option> <option value="RUSTAQ EMERGENCY">RUSTAQ EMERGENCY</option> <option value="HAZAM EMERGENCY">HAZAM EMERGENCY</option> <option value="HOQAIN EMERGENCY">HOQAIN EMERGENCY</option> <option value="KHAFDI EMERGENCY">KHAFDI EMERGENCY</option> <option value="AWABI EMERGENCY">AWABI EMERGENCY</option> <option value="RUSTAQ MAINTENANCES - 1">RUSTAQ MAINTENANCES - 1</option> <option value="HAZAM MAINTENANCES - 2">HAZAM MAINTENANCES - 2</option> <option value="RUSTAQ ASSET SECURITY - 1">RUSTAQ ASSET SECURITY - 1</option> <option value="HAZAM ASSET SECURITY - 1">HAZAM ASSET SECURITY - 1</option> <option value="SUPERVISOR &amp; OTHER">SUPERVISOR &amp; OTHER</option> </select>
         </div>
         <div class="form-group"><label>Name *</label> <input type="text" id="ie-name" required placeholder="Enter name">
         </div>
         <div class="form-group"><label>Resident Country *</label> <select id="ie-resident" required> <option value="">Select Country</option> <option value="üá¥üá≤ Omani">üá¥üá≤ Omani</option> <option value="üáÆüá≥ Indian">üáÆüá≥ Indian</option> <option value="üáµüá∞ Pakistani">üáµüá∞ Pakistani</option> <option value="üáßüá© Bangladeshi">üáßüá© Bangladeshi</option> </select>
         </div>
         <div class="form-group"><label>Transaction Type *</label> <select id="ie-type" required> <option value="">Select Type</option> <option value="I GAVE THE MATERIAL">I GAVE THE MATERIAL</option> <option value="RETURN">RETURN</option> <option value="RECEIVED">RECEIVED</option> <option value="IMPORT">IMPORT</option> <option value="EXPORT">EXPORT</option> </select>
         </div>
         <div class="form-group"><label>Import Date</label> <input type="date" id="ie-import-date">
         </div>
         <div class="form-group"><label>Export Date</label> <input type="date" id="ie-export-date">
         </div>
         <div class="form-group"><label>Requirement Category *</label> <select id="ie-category" required onchange="updateMaterialOptions()"> <option value="">Select Category</option> <option value="PPE">PPE</option> <option value="INSULATION TOOLS">INSULATION TOOLS</option> <option value="OTHERS">OTHERS</option> </select>
         </div>
         <div class="form-group"><label>Material *</label> <select id="ie-material" required onchange="updateSizeOptions()" style="display:block;"> <option value="">Select Material</option> </select> <input type="text" id="ie-material-custom" placeholder="Enter material name" style="display:none; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px;">
         </div>
         <div class="form-group"><label>Size</label> <select id="ie-size" style="display:block;"> <option value="">Select Size</option> </select> <input type="text" id="ie-size-custom" placeholder="Enter size" style="display:none; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px;">
         </div>
         <div class="form-group"><label>Designation</label> <input type="text" id="ie-designation" placeholder="Job designation">
         </div>
         <div class="form-group"><label>Quantity *</label> <input type="number" id="ie-qty" required min="1" placeholder="0">
         </div>
        </div>
        <div class="form-actions"><button type="submit" class="btn btn-primary" id="ie-submit-btn">‚úÖ Add Transaction</button> <button type="button" class="btn btn-secondary" onclick="exportToExcel('import-export')">üì• Export Excel</button> <button type="button" class="btn btn-secondary" onclick="exportToPDF('import-export')">üìÑ Export PDF</button> <button type="reset" class="btn btn-secondary">üîÑ Clear</button>
        </div>
       </form>
      </div>
      <div class="summary-grid">
       <div class="summary-card">
        <div class="number" id="ie-total-import">
         0
        </div>
        <div class="label">
         Total Imports
        </div>
       </div>
       <div class="summary-card">
        <div class="number" id="ie-total-export">
         0
        </div>
        <div class="label">
         Total Exports
        </div>
       </div>
       <div class="summary-card">
        <div class="number" id="ie-net-balance">
         0
        </div>
        <div class="label">
         Net Balance
        </div>
       </div>
      </div>
      <div class="form-group" style="margin-bottom: 20px;"><label>üîç Search by Name</label> <input type="text" id="ie-search" placeholder="Type to search by name..." oninput="filterImportExport()">
      </div>
      <div class="table-wrapper">
       <table>
        <thead>
         <tr>
          <th>Date</th>
          <th>Team</th>
          <th>Name</th>
          <th>Resident</th>
          <th>Type</th>
          <th>Import Date</th>
          <th>Export Date</th>
          <th>Category</th>
          <th>Material</th>
          <th>Size</th>
          <th>Designation</th>
          <th>Qty</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody id="ie-table-body">
         <tr>
          <td colspan="13">
           <div class="empty-state">
            <div class="empty-state-icon">
             üì¶
            </div>
            <h3>No Transactions Yet</h3>
            <p>Add your first transaction above</p>
           </div></td>
         </tr>
        </tbody>
       </table>
      </div>
     </div><!-- Store Stock Module -->
     <div id="stock" class="module-content">
      <div class="form-section">
       <h3>üìä Store Stock Entry</h3>
       <form id="stockForm">
        <div class="form-grid">
         <div class="form-group"><label>Date *</label> <input type="date" id="stock-date" required>
         </div>
         <div class="form-group"><label>Stock Type *</label> <select id="stock-type" required> <option value="">Select Type</option> <option value="IMPORT">IMPORT</option> <option value="EXPORT">EXPORT</option> </select>
         </div>
         <div class="form-group"><label>Material Name *</label> <select id="stock-material" required onchange="updateStockSizeOptions()"> <option value="">Select Material</option> <option value="COVER ALL">COVER ALL</option> <option value="HELMET">HELMET</option> <option value="SHOE">SHOE</option> <option value="SAFETY JACKET">SAFETY JACKET</option> <option value="COTTON GLOVES">COTTON GLOVES</option> <option value="Screwdriver Set Heavy Duty (Star)">Screwdriver Set Heavy Duty (Star)</option> <option value="Screwdriver Set Heavy Duty (Flat)">Screwdriver Set Heavy Duty (Flat)</option> <option value="RING SPANNER">RING SPANNER</option> <option value="OPEN END SPANNER">OPEN END SPANNER</option> <option value="INSULATION TOOLS">INSULATION TOOLS</option> </select>
         </div>
         <div class="form-group"><label>Size</label> <select id="stock-size"> <option value="">Select Size</option> </select>
         </div>
         <div class="form-group"><label>Quantity *</label> <input type="number" id="stock-qty" required min="0" placeholder="0">
         </div>
         <div class="form-group" style="grid-column: span 2;"><label>Remark</label> <textarea id="stock-remark" placeholder="Add remarks here..."></textarea>
         </div>
        </div>
        <div class="form-group" style="margin-top: 15px;"><label>Photo Upload</label>
         <div class="photo-upload" onclick="document.getElementById('stock-photo').click()"><input type="file" id="stock-photo" accept="image/*" onchange="handlePhotoUpload(event, 'stock-preview')">
          <p>üì∑ Click to upload photo</p><small>JPG, PNG or GIF (Max 5MB)</small>
         </div>
         <div id="stock-preview" class="photo-preview"></div>
        </div>
        <div class="form-actions"><button type="submit" class="btn btn-primary" id="stock-submit-btn">‚úÖ Add Stock</button> <button type="button" class="btn btn-secondary" onclick="exportToExcel('stock')">üì• Export Excel</button> <button type="button" class="btn btn-secondary" onclick="exportToPDF('stock')">ÔøΩÔøΩÔøΩ Export PDF</button> <button type="reset" class="btn btn-secondary" onclick="clearPreview('stock-preview')">üîÑ Clear</button>
        </div>
       </form>
      </div>
      <div id="stock-alerts"></div>
      <div class="summary-grid">
       <div class="summary-card">
        <div class="number" id="stock-total-items">
         0
        </div>
        <div class="label">
         Total Items
        </div>
       </div>
       <div class="summary-card">
        <div class="number" id="stock-total-qty">
         0
        </div>
        <div class="label">
         Total Quantity
        </div>
       </div>
      </div>
      <div class="form-group" style="margin-bottom: 20px;"><label>üîç Search by Material Name</label> <input type="text" id="stock-search" placeholder="Type to search by material..." oninput="filterStock()">
      </div>
      <div class="table-wrapper">
       <table>
        <thead>
         <tr>
          <th>Date</th>
          <th>Stock Type</th>
          <th>Material</th>
          <th>Size</th>
          <th>Quantity</th>
          <th>Remark</th>
          <th>Photo</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody id="stock-table-body">
         <tr>
          <td colspan="8">
           <div class="empty-state">
            <div class="empty-state-icon">
             üìä
            </div>
            <h3>No Stock Items Yet</h3>
            <p>Add your first stock item above</p>
           </div></td>
         </tr>
        </tbody>
       </table>
      </div>
     </div><!-- New Arrivals Module -->
     <div id="arrivals" class="module-content">
      <div class="form-section">
       <h3>üÜï New Arrival Material Entry</h3>
       <form id="arrivalsForm">
        <div class="form-grid">
         <div class="form-group"><label>Date *</label> <input type="date" id="arrival-date" required>
         </div>
         <div class="form-group"><label>Supplier *</label> <input type="text" id="arrival-supplier" required placeholder="Supplier name">
         </div>
         <div class="form-group"><label>Material Condition *</label> <select id="arrival-condition" required> <option value="">Select Condition</option> <option value="NEW">NEW</option> <option value="OLD">OLD</option> <option value="RETURN">RETURN</option> </select>
         </div>
         <div class="form-group"><label>Stock Type *</label> <select id="arrival-stock-type" required> <option value="">Select Type</option> <option value="IMPORT">IMPORT</option> <option value="EXPORT">EXPORT</option> </select>
         </div>
         <div class="form-group"><label>Material Category *</label> <select id="arrival-category" required onchange="updateArrivalSizeOptions()"> <option value="">Select Category</option> <option value="COVER ALL">COVER ALL</option> <option value="HELMET">HELMET</option> <option value="SHOE">SHOE</option> <option value="SAFETY JACKET">SAFETY JACKET</option> <option value="COTTON GLOVES">COTTON GLOVES</option> <option value="Screwdriver Set Heavy Duty (Star)">Screwdriver Set Heavy Duty (Star)</option> <option value="Screwdriver Set Heavy Duty (Flat)">Screwdriver Set Heavy Duty (Flat)</option> <option value="RING SPANNER">RING SPANNER</option> <option value="OPEN END SPANNER">OPEN END SPANNER</option> <option value="INSULATION TOOLS">INSULATION TOOLS</option> </select>
         </div>
         <div class="form-group"><label>Material Name *</label> <input type="text" id="arrival-material" required placeholder="Material name">
         </div>
         <div class="form-group"><label>Size</label> <select id="arrival-size"> <option value="">Select Size</option> </select>
         </div>
         <div class="form-group"><label>Quantity *</label> <input type="number" id="arrival-qty" required min="1" placeholder="0">
         </div>
         <div class="form-group" style="grid-column: span 2;"><label>Remark</label> <textarea id="arrival-remark" placeholder="Add remarks here..."></textarea>
         </div>
        </div>
        <div class="form-group" style="margin-top: 15px;"><label>Photo Upload</label>
         <div class="photo-upload" onclick="document.getElementById('arrival-photo').click()"><input type="file" id="arrival-photo" accept="image/*" onchange="handlePhotoUpload(event, 'arrival-preview')">
          <p>üì∑ Click to upload photo</p><small>JPG, PNG or GIF (Max 5MB)</small>
         </div>
         <div id="arrival-preview" class="photo-preview"></div>
        </div>
        <div class="form-actions"><button type="submit" class="btn btn-primary" id="arrival-submit-btn">‚úÖ Add Arrival</button> <button type="button" class="btn btn-secondary" onclick="exportToExcel('arrivals')">üì• Export Excel</button> <button type="button" class="btn btn-secondary" onclick="exportToPDF('arrivals')">üìÑ Export PDF</button> <button type="reset" class="btn btn-secondary" onclick="clearPreview('arrival-preview')">üîÑ Clear</button>
        </div>
       </form>
      </div>
      <div class="summary-grid">
       <div class="summary-card">
        <div class="number" id="arrival-total">
         0
        </div>
        <div class="label">
         Total Arrivals
        </div>
       </div>
       <div class="summary-card">
        <div class="number" id="arrival-new">
         0
        </div>
        <div class="label">
         New Items
        </div>
       </div>
       <div class="summary-card">
        <div class="number" id="arrival-returns">
         0
        </div>
        <div class="label">
         Returns
        </div>
       </div>
      </div>
      <div class="form-group" style="margin-bottom: 20px;"><label>üîç Search by Material or Supplier</label> <input type="text" id="arrival-search" placeholder="Type to search..." oninput="filterArrivals()">
      </div>
      <div class="table-wrapper">
       <table>
        <thead>
         <tr>
          <th>Date</th>
          <th>Supplier</th>
          <th>Condition</th>
          <th>Stock Type</th>
          <th>Category</th>
          <th>Material</th>
          <th>Size</th>
          <th>Quantity</th>
          <th>Remark</th>
          <th>Photo</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody id="arrivals-table-body">
         <tr>
          <td colspan="11">
           <div class="empty-state">
            <div class="empty-state-icon">
             üÜï
            </div>
            <h3>No New Arrivals Yet</h3>
            <p>Add your first arrival above</p>
           </div></td>
         </tr>
        </tbody>
       </table>
      </div>
     </div><!-- Tool Calibration Module -->
     <div id="calibration" class="module-content">
      <div class="form-section">
       <h3>üîß Tool Calibration Entry</h3>
       <form id="calibrationForm">
        <div class="form-grid">
         <div class="form-group"><label>Equipment/Tool Name *</label> <select id="cal-equipment" required> <option value="">Select Equipment</option> <option value="HIGH VOLTAGE DETECTOR">HIGH VOLTAGE DETECTOR</option> <option value="5 KV MEGGAR">5 KV MEGGAR</option> <option value="PHASE ROTATION METER">PHASE ROTATION METER</option> <option value="ANALOG EARTH TESTER">ANALOG EARTH TESTER</option> <option value="LOW VOLTAGE DETECTOR">LOW VOLTAGE DETECTOR</option> <option value="CLAMP METER">CLAMP METER</option> <option value="THERMAL CAMERA">THERMAL CAMERA</option> <option value="CABLE DETECTOR">CABLE DETECTOR</option> </select>
         </div>
         <div class="form-group"><label>Serial Number *</label> <input type="text" id="cal-serial" required placeholder="Serial number">
         </div>
         <div class="form-group"><label>Camp/Location</label> <input type="text" id="cal-camp" placeholder="Camp location">
         </div>
         <div class="form-group"><label>Calibration Date (M/D/Y) *</label> <input type="date" id="cal-date" required>
         </div>
         <div class="form-group"><label>Due Calibration Date (M/D/Y) *</label> <input type="date" id="cal-due-date" required>
         </div>
        </div>
        <div class="form-actions"><button type="submit" class="btn btn-primary" id="cal-submit-btn">‚úÖ Add Calibration</button> <button type="button" class="btn btn-secondary" onclick="exportToExcel('calibration')">üì• Export Excel</button> <button type="button" class="btn btn-secondary" onclick="exportToPDF('calibration')">ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ Export PDF</button> <button type="reset" class="btn btn-secondary">üîÑ Clear</button>
        </div>
       </form>
      </div>
      <div id="calibration-alerts"></div>
      <div class="summary-grid">
       <div class="summary-card">
        <div class="number" id="cal-total">
         0
        </div>
        <div class="label">
         Total Tools
        </div>
       </div>
       <div class="summary-card">
        <div class="number" id="cal-valid">
         0
        </div>
        <div class="label">
         Valid
        </div>
       </div>
       <div class="summary-card">
        <div class="number" id="cal-expired">
         0
        </div>
        <div class="label">
         Expired
        </div>
       </div>
       <div class="summary-card">
        <div class="number" id="cal-rejected">
         0
        </div>
        <div class="label">
         Rejected
        </div>
       </div>
      </div>
      <div class="form-group" style="margin-bottom: 20px;"><label>üîç Search by Equipment or Serial</label> <input type="text" id="cal-search" placeholder="Type to search..." oninput="filterCalibration()">
      </div>
      <div class="table-wrapper">
       <table>
        <thead>
         <tr>
          <th>Equipment</th>
          <th>Serial No.</th>
          <th>Camp</th>
          <th>Cal. Date</th>
          <th>Due Date</th>
          <th>Days Remaining</th>
          <th>Status</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody id="calibration-table-body">
         <tr>
          <td colspan="8">
           <div class="empty-state">
            <div class="empty-state-icon">
             üîß
            </div>
            <h3>No Calibration Records Yet</h3>
            <p>Add your first calibration record above</p>
           </div></td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div>
    <div class="download-section">
     <h3>üì• ALL DOWNLOAD - EXCEL &amp; PDF</h3>
     <div class="download-grid"><button class="download-btn excel" onclick="downloadAllExcel()"> <span>üìä</span> Download All Excel </button> <button class="download-btn pdf" onclick="downloadAllPDF()"> <span>üìÑ</span> Download All PDF </button> <button class="download-btn excel" onclick="exportToExcel('import-export')"> <span>üì¶</span> Import/Export Excel </button> <button class="download-btn excel" onclick="exportToExcel('stock')"> <span>üìä</span> Stock Excel </button> <button class="download-btn excel" onclick="exportToExcel('arrivals')"> <span>üÜï</span> Arrivals Excel </button> <button class="download-btn excel" onclick="exportToExcel('calibration')"> <span>üîß</span> Calibration Excel </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Global data store
    let allRecords = [];
    let filteredRecords = {
      'import-export': [],
      'stock': [],
      'arrivals': [],
      'calibration': []
    };

    // Material and Size Mappings
    const materialData = {
      'PPE': ['COVER ALL', 'HELMET', 'SHOE', 'SAFETY JACKET', 'COTTON GLOVES'],
      'INSULATION TOOLS': [
        'HIGH VOLTAGE DETECTOR',
        '5 KV MEGGAR',
        'PHASE ROTATION METER',
        'ANALOG EARTH TESTER',
        'LOW VOLTAGE DETECTOR',
        'CLAMP METER',
        'THERMAL CAMERA',
        'CABLE DETECTOR',
        'Low Voltage Tester (Approved by HSE)',
        'Live Line Tester (11 KV and 33 KV)',
        'Fiberglass Insulated Ladder',
        'Adjustment Spanner',
        'Crimping tools',
        'Box spanner Set',
        'Knife',
        'Safety Belt (Pole Climbing)',
        'Safety Harness (Pole Climbing)',
        'LV Rubber Gloves',
        '11 KV Rubber Gloves',
        '33 KV Rubber Gloves',
        'Clamp Meter (AVO Meter)',
        'Operating Rod',
        'Spot Light',
        'Earth Kit For H.T and L.T (Approved Type)',
        'Voltmeter (Megger 5 and 1KV)',
        'Wire Cutter',
        'Combination Pliers',
        'Side cutting Pliers',
        'Nose Pliers',
        'Hummer',
        'Fire Extinguisher',
        'First Aid tools',
        'Pole Climber (Wooden)',
        'Pole Climber (Concrete)',
        'Hand shovel',
        'Drilling Set',
        'Hacksaw Frame',
        'Air Blower',
        'Erath resistance Meter',
        'Screwdriver Set Heavy Duty (Star)',
        'Screwdriver Set Heavy Duty (Flat)',
        'Measurement Tape',
        'PHASE rotation tester',
        'Torch',
        'Safety Cone barriers with Plastic Chain',
        'Small Generator 5 KW',
        'Tree Trimmer Rode',
        'Helmet With ARC Flash shield',
        'TOOLS CARRY BOX',
        'Tab (10Inch, 4 Gb Ram, 256 Gb Memory)',
        'RING SPANNER',
        'OPEN END SPANNER',
        'BUCK LADDER ROPE & STRAPS',
        'LINEMAN BELT'
      ],
      'HIAP': ['CUSTOM'],
      'OTHERS': ['Miscellaneous']
    };

    const sizeData = {
      'COVER ALL': ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'],
      'HELMET': ['YELLOW', 'BLUE', 'WHITE'],
      'SHOE': ['35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46'],
      'SAFETY JACKET': ['RED', 'GREEN'],
      'Screwdriver Set Heavy Duty (Star)': ['SMALL', 'MEDIUM', 'BIG'],
      'Screwdriver Set Heavy Duty (Flat)': ['SMALL', 'MEDIUM', 'BIG'],
      'RING SPANNER': ['6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '17', '18', '19', '20', '22', '24', '26', '28', '30', '32', '34'],
      'OPEN END SPANNER': ['6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '17', '18', '19', '20', '22', '24', '26', '28', '30', '32', '34']
    };

    // Data Handler
    const dataHandler = {
      onDataChanged(data) {
        allRecords = data;
        
        // Initialize filtered records with all data
        filteredRecords = {
          'import-export': [],
          'stock': [],
          'arrivals': [],
          'calibration': []
        };
        
        renderImportExport();
        renderStock();
        renderArrivals();
        renderCalibration();
        updateAllStats();
      }
    };

    // Initialize SDK
    (async () => {
      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error('Failed to initialize Data SDK');
        }
      }

      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      document.querySelectorAll('input[type="date"]').forEach(input => {
        if (!input.value) input.value = today;
      });
    })();

    // Helper functions
    function getModuleRecords(module) {
      return allRecords.filter(r => r.module === module);
    }

    function showLoadingState(buttonId, isLoading) {
      const button = document.getElementById(buttonId);
      if (!button) return;
      
      if (isLoading) {
        button.disabled = true;
        const originalText = button.innerHTML;
        button.dataset.originalText = originalText;
        button.innerHTML = '<span class="loading-spinner"></span> Saving...';
      } else {
        button.disabled = false;
        button.innerHTML = button.dataset.originalText || button.innerHTML;
      }
    }

    function showMessage(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ö†Ô∏è'}</span><div>${message}</div>`;
      
      const activeModule = document.querySelector('.module-content.active');
      const formSection = activeModule.querySelector('.form-section');
      formSection.insertAdjacentElement('beforebegin', alertDiv);
      
      setTimeout(() => alertDiv.remove(), 3000);
    }

    // Update material options based on category
    function updateMaterialOptions() {
      const category = document.getElementById('ie-category').value;
      const materialSelect = document.getElementById('ie-material');
      const materialCustom = document.getElementById('ie-material-custom');
      const sizeSelect = document.getElementById('ie-size');
      const sizeCustom = document.getElementById('ie-size-custom');
      
      materialSelect.innerHTML = '<option value="">Select Material</option>';
      
      if (category === 'HIAP') {
        // For HIAP, show custom text inputs
        materialSelect.style.display = 'none';
        materialCustom.style.display = 'block';
        materialCustom.required = true;
        materialSelect.required = false;
        
        sizeSelect.style.display = 'none';
        sizeCustom.style.display = 'block';
      } else {
        // For other categories, show dropdowns
        materialSelect.style.display = 'block';
        materialCustom.style.display = 'none';
        materialCustom.required = false;
        materialSelect.required = true;
        
        sizeSelect.style.display = 'block';
        sizeCustom.style.display = 'none';
        
        if (category && materialData[category]) {
          materialData[category].forEach(material => {
            const option = document.createElement('option');
            option.value = material;
            option.textContent = material;
            materialSelect.appendChild(option);
          });
        }
      }
    }

    // Update size options based on material
    function updateSizeOptions() {
      const material = document.getElementById('ie-material').value;
      const sizeSelect = document.getElementById('ie-size');
      sizeSelect.innerHTML = '<option value="">Select Size</option>';
      
      if (material && sizeData[material]) {
        sizeData[material].forEach(size => {
          const option = document.createElement('option');
          option.value = size;
          option.textContent = size;
          sizeSelect.appendChild(option);
        });
      }
    }

    function updateStockSizeOptions() {
      const material = document.getElementById('stock-material').value;
      const sizeSelect = document.getElementById('stock-size');
      sizeSelect.innerHTML = '<option value="">Select Size</option>';
      
      if (material && sizeData[material]) {
        sizeData[material].forEach(size => {
          const option = document.createElement('option');
          option.value = size;
          option.textContent = size;
          sizeSelect.appendChild(option);
        });
      }
    }

    function updateArrivalSizeOptions() {
      const category = document.getElementById('arrival-category').value;
      const sizeSelect = document.getElementById('arrival-size');
      sizeSelect.innerHTML = '<option value="">Select Size</option>';
      
      if (category && sizeData[category]) {
        sizeData[category].forEach(size => {
          const option = document.createElement('option');
          option.value = size;
          option.textContent = size;
          sizeSelect.appendChild(option);
        });
      }
    }

    // Photo Upload Handler
    function handlePhotoUpload(event, previewId) {
      const file = event.target.files[0];
      if (file && file.size <= 5 * 1024 * 1024) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById(previewId);
          preview.innerHTML = `<img src="${e.target.result}" alt="Photo">`;
        };
        reader.readAsDataURL(file);
      } else {
        showMessage('File size must be less than 5MB', 'danger');
      }
    }

    function clearPreview(previewId) {
      document.getElementById(previewId).innerHTML = '';
    }

    // Module Navigation
    function showModule(moduleName) {
      document.querySelectorAll('.module-content').forEach(m => m.classList.remove('active'));
      document.querySelectorAll('.module-btn').forEach(b => b.classList.remove('active'));
      
      document.getElementById(moduleName).classList.add('active');
      event.target.closest('.module-btn').classList.add('active');
    }

    // Import & Export Form
    document.getElementById('importExportForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (allRecords.length >= 999) {
        showMessage('Maximum limit of 999 records reached. Please delete some records first.', 'danger');
        return;
      }
      
      showLoadingState('ie-submit-btn', true);
      
      const category = document.getElementById('ie-category').value;
      const isHIAP = category === 'HIAP';
      
      const entry = {
        module: 'import-export',
        date: document.getElementById('ie-date').value,
        team: document.getElementById('ie-team').value,
        name: document.getElementById('ie-name').value,
        resident: document.getElementById('ie-resident').value,
        type: document.getElementById('ie-type').value,
        importDate: document.getElementById('ie-import-date').value || '',
        exportDate: document.getElementById('ie-export-date').value || '',
        category: category,
        material: isHIAP ? document.getElementById('ie-material-custom').value : document.getElementById('ie-material').value,
        size: isHIAP ? document.getElementById('ie-size-custom').value || '' : document.getElementById('ie-size').value || '',
        designation: document.getElementById('ie-designation').value || '',
        qty: parseInt(document.getElementById('ie-qty').value)
      };
      
      const result = await window.dataSdk.create(entry);
      showLoadingState('ie-submit-btn', false);
      
      if (result.isOk) {
        showMessage('Transaction added successfully!', 'success');
        e.target.reset();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('ie-date').value = today;
      } else {
        showMessage('Failed to add transaction. Please try again.', 'danger');
      }
    });

    // Filter functions
    function filterImportExport() {
      const searchTerm = document.getElementById('ie-search').value.toLowerCase();
      const records = getModuleRecords('import-export');
      
      if (searchTerm === '') {
        filteredRecords['import-export'] = records;
      } else {
        filteredRecords['import-export'] = records.filter(r => 
          r.name.toLowerCase().includes(searchTerm)
        );
      }
      renderImportExport();
    }

    function filterStock() {
      const searchTerm = document.getElementById('stock-search').value.toLowerCase();
      const records = getModuleRecords('stock');
      
      if (searchTerm === '') {
        filteredRecords['stock'] = records;
      } else {
        filteredRecords['stock'] = records.filter(r => 
          r.material.toLowerCase().includes(searchTerm)
        );
      }
      renderStock();
    }

    function filterArrivals() {
      const searchTerm = document.getElementById('arrival-search').value.toLowerCase();
      const records = getModuleRecords('arrivals');
      
      if (searchTerm === '') {
        filteredRecords['arrivals'] = records;
      } else {
        filteredRecords['arrivals'] = records.filter(r => 
          r.material.toLowerCase().includes(searchTerm) ||
          r.supplier.toLowerCase().includes(searchTerm)
        );
      }
      renderArrivals();
    }

    function filterCalibration() {
      const searchTerm = document.getElementById('cal-search').value.toLowerCase();
      const records = getModuleRecords('calibration');
      
      if (searchTerm === '') {
        filteredRecords['calibration'] = records;
      } else {
        filteredRecords['calibration'] = records.filter(r => 
          r.equipment.toLowerCase().includes(searchTerm) ||
          r.serial.toLowerCase().includes(searchTerm)
        );
      }
      renderCalibration();
    }

    function renderImportExport() {
      const tbody = document.getElementById('ie-table-body');
      const allModuleRecords = getModuleRecords('import-export');
      const records = filteredRecords['import-export'].length > 0 || document.getElementById('ie-search').value !== '' 
        ? filteredRecords['import-export'] 
        : allModuleRecords;
      
      if (records.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="13">
              <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <h3>No Transactions Yet</h3>
                <p>Add your first transaction above</p>
              </div>
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = records.map(item => {
          let badgeClass = 'badge-import';
          if (item.type === 'EXPORT') badgeClass = 'badge-export';
          else if (item.type === 'I GAVE THE MATERIAL') badgeClass = 'badge-gave';
          else if (item.type === 'RETURN') badgeClass = 'badge-return';
          else if (item.type === 'RECEIVED') badgeClass = 'badge-received';
          
          return `
            <tr>
              <td>${item.date}</td>
              <td>${item.team}</td>
              <td>${item.name}</td>
              <td>${item.resident}</td>
              <td><span class="badge ${badgeClass}">${item.type}</span></td>
              <td>${item.importDate || '-'}</td>
              <td>${item.exportDate || '-'}</td>
              <td>${item.category}</td>
              <td>${item.material}</td>
              <td>${item.size || '-'}</td>
              <td>${item.designation || '-'}</td>
              <td><strong>${item.qty}</strong></td>
              <td>
                <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteEntry('${item.__backendId}')">üóëÔ∏è</button>
              </td>
            </tr>
          `;
        }).join('');
      }
      
      updateImportExportSummary();
    }

    function updateImportExportSummary() {
      const records = getModuleRecords('import-export');
      const totalImport = records
        .filter(i => i.type === 'IMPORT' || i.type === 'RECEIVED')
        .reduce((sum, i) => sum + i.qty, 0);
      
      const totalExport = records
        .filter(i => i.type === 'EXPORT' || i.type === 'I GAVE THE MATERIAL')
        .reduce((sum, i) => sum + i.qty, 0);
      
      document.getElementById('ie-total-import').textContent = totalImport;
      document.getElementById('ie-total-export').textContent = totalExport;
      document.getElementById('ie-net-balance').textContent = totalImport - totalExport;
    }

    // Stock Form
    document.getElementById('stockForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (allRecords.length >= 999) {
        showMessage('Maximum limit of 999 records reached. Please delete some records first.', 'danger');
        return;
      }
      
      showLoadingState('stock-submit-btn', true);
      
      const photoPreview = document.getElementById('stock-preview').innerHTML;
      
      const entry = {
        module: 'stock',
        date: document.getElementById('stock-date').value,
        stockType: document.getElementById('stock-type').value,
        material: document.getElementById('stock-material').value,
        size: document.getElementById('stock-size').value || '',
        qty: parseInt(document.getElementById('stock-qty').value),
        remark: document.getElementById('stock-remark').value || '',
        photo: photoPreview
      };
      
      const result = await window.dataSdk.create(entry);
      showLoadingState('stock-submit-btn', false);
      
      if (result.isOk) {
        showMessage('Stock item added successfully!', 'success');
        e.target.reset();
        clearPreview('stock-preview');
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('stock-date').value = today;
      } else {
        showMessage('Failed to add stock item. Please try again.', 'danger');
      }
    });

    function renderStock() {
      const tbody = document.getElementById('stock-table-body');
      const allModuleRecords = getModuleRecords('stock');
      const records = filteredRecords['stock'].length > 0 || document.getElementById('stock-search').value !== '' 
        ? filteredRecords['stock'] 
        : allModuleRecords;
      
      if (records.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <h3>No Stock Items Yet</h3>
                <p>Add your first stock item above</p>
              </div>
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = records.map(item => `
          <tr>
            <td>${item.date}</td>
            <td><span class="badge ${item.stockType === 'IMPORT' ? 'badge-import' : 'badge-export'}">${item.stockType}</span></td>
            <td>${item.material}</td>
            <td>${item.size || '-'}</td>
            <td><strong>${item.qty}</strong></td>
            <td>${item.remark || '-'}</td>
            <td>${item.photo ? item.photo.replace('width: 100px; height: 100px;', 'width: 60px; height: 60px;').replace('<img', '<img class="photo-thumbnail"') : 'üì∑'}</td>
            <td>
              <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteEntry('${item.__backendId}')">üóëÔ∏è</button>
            </td>
          </tr>
        `).join('');
      }
      
      updateStockSummary();
    }

    function updateStockSummary() {
      const records = getModuleRecords('stock');
      const totalQty = records.reduce((sum, item) => sum + item.qty, 0);
      document.getElementById('stock-total-items').textContent = records.length;
      document.getElementById('stock-total-qty').textContent = totalQty;
    }

    // Arrivals Form
    document.getElementById('arrivalsForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (allRecords.length >= 999) {
        showMessage('Maximum limit of 999 records reached. Please delete some records first.', 'danger');
        return;
      }
      
      showLoadingState('arrival-submit-btn', true);
      
      const photoPreview = document.getElementById('arrival-preview').innerHTML;
      
      const entry = {
        module: 'arrivals',
        date: document.getElementById('arrival-date').value,
        supplier: document.getElementById('arrival-supplier').value,
        condition: document.getElementById('arrival-condition').value,
        stockType: document.getElementById('arrival-stock-type').value,
        category: document.getElementById('arrival-category').value,
        material: document.getElementById('arrival-material').value,
        size: document.getElementById('arrival-size').value || '',
        qty: parseInt(document.getElementById('arrival-qty').value),
        remark: document.getElementById('arrival-remark').value || '',
        photo: photoPreview
      };
      
      const result = await window.dataSdk.create(entry);
      showLoadingState('arrival-submit-btn', false);
      
      if (result.isOk) {
        showMessage('Arrival added successfully!', 'success');
        e.target.reset();
        clearPreview('arrival-preview');
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('arrival-date').value = today;
      } else {
        showMessage('Failed to add arrival. Please try again.', 'danger');
      }
    });

    function renderArrivals() {
      const tbody = document.getElementById('arrivals-table-body');
      const allModuleRecords = getModuleRecords('arrivals');
      const records = filteredRecords['arrivals'].length > 0 || document.getElementById('arrival-search').value !== '' 
        ? filteredRecords['arrivals'] 
        : allModuleRecords;
      
      if (records.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="11">
              <div class="empty-state">
                <div class="empty-state-icon">ÔøΩÔøΩÔøΩ</div>
                <h3>No New Arrivals Yet</h3>
                <p>Add your first arrival above</p>
              </div>
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = records.map(item => `
          <tr>
            <td>${item.date}</td>
            <td>${item.supplier}</td>
            <td><span class="badge badge-${item.condition === 'NEW' ? 'valid' : 'import'}">${item.condition}</span></td>
            <td><span class="badge ${item.stockType === 'IMPORT' ? 'badge-import' : 'badge-export'}">${item.stockType}</span></td>
            <td>${item.category}</td>
            <td>${item.material}</td>
            <td>${item.size || '-'}</td>
            <td><strong>${item.qty}</strong></td>
            <td>${item.remark || '-'}</td>
            <td>${item.photo ? item.photo.replace('width: 100px; height: 100px;', 'width: 60px; height: 60px;').replace('<img', '<img class="photo-thumbnail"') : 'üì∑'}</td>
            <td>
              <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteEntry('${item.__backendId}')">üóëÔ∏è</button>
            </td>
          </tr>
        `).join('');
      }
      
      updateArrivalsSummary();
    }

    function updateArrivalsSummary() {
      const records = getModuleRecords('arrivals');
      document.getElementById('arrival-total').textContent = records.length;
      document.getElementById('arrival-new').textContent = records.filter(a => a.condition === 'NEW').length;
      document.getElementById('arrival-returns').textContent = records.filter(a => a.condition === 'RETURN').length;
    }

    // Calibration Form
    document.getElementById('calibrationForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (allRecords.length >= 999) {
        showMessage('Maximum limit of 999 records reached. Please delete some records first.', 'danger');
        return;
      }
      
      showLoadingState('cal-submit-btn', true);
      
      const calDate = document.getElementById('cal-date').value;
      const dueDate = document.getElementById('cal-due-date').value;
      const status = calculateCalibrationStatus(calDate, dueDate);
      
      const entry = {
        module: 'calibration',
        equipment: document.getElementById('cal-equipment').value,
        serial: document.getElementById('cal-serial').value,
        camp: document.getElementById('cal-camp').value || '',
        calDate: calDate,
        dueDate: dueDate,
        status: status
      };
      
      const result = await window.dataSdk.create(entry);
      showLoadingState('cal-submit-btn', false);
      
      if (result.isOk) {
        showMessage('Calibration record added successfully!', 'success');
        e.target.reset();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('cal-date').value = today;
      } else {
        showMessage('Failed to add calibration record. Please try again.', 'danger');
      }
    });

    function calculateCalibrationStatus(calDate, dueDate) {
      const today = new Date();
      const due = new Date(dueDate);
      const cal = new Date(calDate);
      
      if (cal.getTime() === due.getTime()) {
        return 'REJECTED';
      } else if (today > due) {
        return 'EXPIRED';
      } else {
        return 'VALID';
      }
    }

    function renderCalibration() {
      const tbody = document.getElementById('calibration-table-body');
      const allModuleRecords = getModuleRecords('calibration');
      const records = filteredRecords['calibration'].length > 0 || document.getElementById('cal-search').value !== '' 
        ? filteredRecords['calibration'] 
        : allModuleRecords;
      
      if (records.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-state-icon">üîß</div>
                <h3>No Calibration Records Yet</h3>
                <p>Add your first calibration record above</p>
              </div>
            </td>
          </tr>
        `;
        document.getElementById('calibration-alerts').innerHTML = '';
      } else {
        tbody.innerHTML = records.map(item => {
          const daysRemaining = calculateDaysRemaining(item.dueDate);
          const daysClass = daysRemaining <= 0 ? 'days-critical' : daysRemaining <= 30 ? 'days-warning' : 'days-good';
          const daysIcon = daysRemaining <= 0 ? 'üî¥' : daysRemaining <= 30 ? 'üü°' : 'üü¢';
          
          return `
            <tr>
              <td>${item.equipment}</td>
              <td>${item.serial}</td>
              <td>${item.camp || '-'}</td>
              <td>${item.calDate}</td>
              <td>${item.dueDate}</td>
              <td>
                <span class="days-remaining ${daysClass}">
                  ${daysIcon} ${daysRemaining} days
                </span>
              </td>
              <td>
                <span class="badge badge-${item.status.toLowerCase()}">${item.status}</span>
              </td>
              <td>
                <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteEntry('${item.__backendId}')">üóëÔ∏è</button>
              </td>
            </tr>
          `;
        }).join('');
        
        updateCalibrationAlerts();
      }
    }

    function calculateDaysRemaining(dueDate) {
      const today = new Date();
      const due = new Date(dueDate);
      const diffTime = due - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }

    function updateCalibrationAlerts() {
      const records = getModuleRecords('calibration');
      const expired = records.filter(item => item.status === 'EXPIRED');
      const expiringSoon = records.filter(item => {
        const days = calculateDaysRemaining(item.dueDate);
        return item.status === 'VALID' && days > 0 && days <= 30;
      });
      
      const alertsDiv = document.getElementById('calibration-alerts');
      let alertsHTML = '';
      
      if (expired.length > 0) {
        const expiredList = expired.map(e => `${e.equipment} (${e.serial}) - Due: ${e.dueDate}`).join('<br>');
        alertsHTML += `
          <div class="alert alert-danger">
            <span style="font-size: 24px;">üî¥</span>
            <div>
              <strong>Expired Tools Reminder!</strong> ${expired.length} tool(s) have expired calibration:<br>
              <small style="margin-top: 5px; display: block;">${expiredList}</small>
            </div>
          </div>
        `;
      }
      
      if (expiringSoon.length > 0) {
        alertsHTML += `
          <div class="alert alert-warning">
            <span style="font-size: 24px;">üü°</span>
            <div>
              <strong>Expiring Soon!</strong> ${expiringSoon.length} tool(s) will expire within 30 days.
            </div>
          </div>
        `;
      }
      
      alertsDiv.innerHTML = alertsHTML;
      
      document.getElementById('cal-total').textContent = records.length;
      document.getElementById('cal-valid').textContent = records.filter(c => c.status === 'VALID').length;
      document.getElementById('cal-expired').textContent = records.filter(c => c.status === 'EXPIRED').length;
      document.getElementById('cal-rejected').textContent = records.filter(c => c.status === 'REJECTED').length;
    }

    // Delete Entry
    async function deleteEntry(backendId) {
      const record = allRecords.find(r => r.__backendId === backendId);
      if (!record) return;
      
      const result = await window.dataSdk.delete(record);
      
      if (result.isOk) {
        showMessage('Record deleted successfully!', 'success');
      } else {
        showMessage('Failed to delete record. Please try again.', 'danger');
      }
    }

    // Update All Stats
    function updateAllStats() {
      document.getElementById('totalTransactions').textContent = getModuleRecords('import-export').length;
      document.getElementById('totalStock').textContent = getModuleRecords('stock').length;
      document.getElementById('totalArrivals').textContent = getModuleRecords('arrivals').length;
      document.getElementById('totalCalibrations').textContent = getModuleRecords('calibration').length;
    }

    // Download All Excel
    function downloadAllExcel() {
      let csvContent = '=== RUSTAQ STORE MANAGEMENT - COMPLETE REPORT ===\n\n';
      
      // Import/Export Section
      csvContent += '--- IMPORT & EXPORT TRANSACTIONS ---\n';
      csvContent += 'Date,Team,Name,Resident,Type,Import Date,Export Date,Category,Material,Size,Designation,Quantity\n';
      getModuleRecords('import-export').forEach(item => {
        csvContent += `${item.date},${item.team},${item.name},${item.resident},${item.type},${item.importDate || ''},${item.exportDate || ''},${item.category},${item.material},${item.size || ''},${item.designation || ''},${item.qty}\n`;
      });
      
      // Stock Section
      csvContent += '\n--- STORE STOCK ---\n';
      csvContent += 'Date,Stock Type,Material,Size,Quantity,Remark\n';
      getModuleRecords('stock').forEach(item => {
        csvContent += `${item.date},${item.stockType},${item.material},${item.size || ''},${item.qty},${item.remark || ''}\n`;
      });
      
      // Arrivals Section
      csvContent += '\n--- NEW ARRIVALS ---\n';
      csvContent += 'Date,Supplier,Condition,Stock Type,Category,Material,Size,Quantity,Remark\n';
      getModuleRecords('arrivals').forEach(item => {
        csvContent += `${item.date},${item.supplier},${item.condition},${item.stockType},${item.category},${item.material},${item.size || ''},${item.qty},${item.remark || ''}\n`;
      });
      
      // Calibration Section
      csvContent += '\n--- TOOL CALIBRATION ---\n';
      csvContent += 'Equipment,Serial No,Camp,Calibration Date,Due Date,Status\n';
      getModuleRecords('calibration').forEach(item => {
        csvContent += `${item.equipment},${item.serial},${item.camp || ''},${item.calDate},${item.dueDate},${item.status}\n`;
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'rustaq-store-complete-report.csv';
      link.click();
    }

    // Download All PDF
    function downloadAllPDF() {
      const printWindow = window.open('', '_blank');
      
      let content = `
        <h2>üì¶ IMPORT & EXPORT TRANSACTIONS</h2>
        ${generatePrintTable(
          ['Date', 'Team', 'Name', 'Resident', 'Type', 'Material', 'Size', 'Qty'], 
          getModuleRecords('import-export').map(i => [i.date, i.team, i.name, i.resident, i.type, i.material, i.size || '-', i.qty])
        )}
        
        <h2 style="margin-top: 40px;">üìä STORE STOCK</h2>
        ${generatePrintTable(
          ['Date', 'Stock Type', 'Material', 'Size', 'Quantity', 'Remark'], 
          getModuleRecords('stock').map(i => [i.date, i.stockType, i.material, i.size || '-', i.qty, i.remark || '-'])
        )}
        
        <h2 style="margin-top: 40px;">ÔøΩÔøΩ NEW ARRIVALS</h2>
        ${generatePrintTable(
          ['Date', 'Supplier', 'Condition', 'Stock Type', 'Category', 'Material', 'Size', 'Qty'], 
          getModuleRecords('arrivals').map(i => [i.date, i.supplier, i.condition, i.stockType, i.category, i.material, i.size || '-', i.qty])
        )}
        
        <h2 style="margin-top: 40px;">üîß TOOL CALIBRATION</h2>
        ${generatePrintTable(
          ['Equipment', 'Serial No', 'Camp', 'Cal. Date', 'Due Date', 'Status'], 
          getModuleRecords('calibration').map(i => [i.equipment, i.serial, i.camp || '-', i.calDate, i.dueDate, i.status])
        )}
      `;
      
      printWindow.document.write(`
        <html>
          <head>
            <title>Rustaq Store Management - Complete Report</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h1 { color: #1e40af; text-align: center; border-bottom: 3px solid #dc2626; padding-bottom: 10px; }
              h2 { color: #1e40af; margin-top: 30px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px; }
              table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 30px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 11px; }
              th { background: #1e40af; color: white; }
              .header-info { text-align: center; color: #666; margin-bottom: 20px; }
              @media print { button { display: none; } }
              @page { margin: 1cm; }
            </style>
          </head>
          <body>
            <h1>üìä RUSTAQ STORE MANAGEMENT</h1>
            <div class="header-info">
              <p><strong>Complete Report</strong></p>
              <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
              <p>Total Transactions: ${getModuleRecords('import-export').length} | Stock Items: ${getModuleRecords('stock').length} | Arrivals: ${getModuleRecords('arrivals').length} | Calibrations: ${getModuleRecords('calibration').length}</p>
            </div>
            ${content}
            <button onclick="window.print()" style="margin-top: 30px; padding: 15px 30px; background: #1e40af; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">üñ®Ô∏è Print / Save as PDF</button>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    // Export to Excel (CSV format)
    function exportToExcel(type) {
      let csvContent = '';
      let filename = '';
      let records = [];
      
      switch(type) {
        case 'import-export':
          const searchIE = document.getElementById('ie-search').value;
          records = searchIE !== '' ? filteredRecords['import-export'] : getModuleRecords('import-export');
          csvContent = 'Date,Team,Name,Resident,Type,Import Date,Export Date,Category,Material,Size,Designation,Quantity\n';
          records.forEach(item => {
            csvContent += `${item.date},${item.team},${item.name},${item.resident},${item.type},${item.importDate || ''},${item.exportDate || ''},${item.category},${item.material},${item.size || ''},${item.designation || ''},${item.qty}\n`;
          });
          filename = searchIE !== '' ? 'import-export-filtered.csv' : 'import-export.csv';
          break;
          
        case 'stock':
          const searchStock = document.getElementById('stock-search').value;
          records = searchStock !== '' ? filteredRecords['stock'] : getModuleRecords('stock');
          csvContent = 'Date,Stock Type,Material,Size,Quantity,Remark\n';
          records.forEach(item => {
            csvContent += `${item.date},${item.stockType},${item.material},${item.size || ''},${item.qty},${item.remark || ''}\n`;
          });
          filename = searchStock !== '' ? 'stock-filtered.csv' : 'stock.csv';
          break;
          
        case 'arrivals':
          const searchArrival = document.getElementById('arrival-search').value;
          records = searchArrival !== '' ? filteredRecords['arrivals'] : getModuleRecords('arrivals');
          csvContent = 'Date,Supplier,Condition,Stock Type,Category,Material,Size,Quantity,Remark\n';
          records.forEach(item => {
            csvContent += `${item.date},${item.supplier},${item.condition},${item.stockType},${item.category},${item.material},${item.size || ''},${item.qty},${item.remark || ''}\n`;
          });
          filename = searchArrival !== '' ? 'arrivals-filtered.csv' : 'arrivals.csv';
          break;
          
        case 'calibration':
          const searchCal = document.getElementById('cal-search').value;
          records = searchCal !== '' ? filteredRecords['calibration'] : getModuleRecords('calibration');
          csvContent = 'Equipment,Serial No,Camp,Calibration Date,Due Date,Status\n';
          records.forEach(item => {
            csvContent += `${item.equipment},${item.serial},${item.camp || ''},${item.calDate},${item.dueDate},${item.status}\n`;
          });
          filename = searchCal !== '' ? 'calibration-filtered.csv' : 'calibration.csv';
          break;
      }
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    // Export to PDF (simplified HTML print)
    function exportToPDF(type) {
      const printWindow = window.open('', '_blank');
      let content = '';
      let title = '';
      let records = [];
      
      switch(type) {
        case 'import-export':
          const searchIE = document.getElementById('ie-search').value;
          records = searchIE !== '' ? filteredRecords['import-export'] : getModuleRecords('import-export');
          title = 'Import & Export Report' + (searchIE !== '' ? ' (Filtered)' : '');
          content = generatePrintTable(['Date', 'Team', 'Name', 'Resident', 'Type', 'Material', 'Size', 'Qty'], 
            records.map(i => [i.date, i.team, i.name, i.resident, i.type, i.material, i.size || '-', i.qty]));
          break;
          
        case 'stock':
          const searchStock = document.getElementById('stock-search').value;
          records = searchStock !== '' ? filteredRecords['stock'] : getModuleRecords('stock');
          title = 'Stock Report' + (searchStock !== '' ? ' (Filtered)' : '');
          content = generatePrintTable(['Date', 'Stock Type', 'Material', 'Size', 'Quantity', 'Remark'], 
            records.map(i => [i.date, i.stockType, i.material, i.size || '-', i.qty, i.remark || '-']));
          break;
          
        case 'arrivals':
          const searchArrival = document.getElementById('arrival-search').value;
          records = searchArrival !== '' ? filteredRecords['arrivals'] : getModuleRecords('arrivals');
          title = 'New Arrivals Report' + (searchArrival !== '' ? ' (Filtered)' : '');
          content = generatePrintTable(['Date', 'Supplier', 'Condition', 'Stock Type', 'Category', 'Material', 'Size', 'Qty'], 
            records.map(i => [i.date, i.supplier, i.condition, i.stockType, i.category, i.material, i.size || '-', i.qty]));
          break;
          
        case 'calibration':
          const searchCal = document.getElementById('cal-search').value;
          records = searchCal !== '' ? filteredRecords['calibration'] : getModuleRecords('calibration');
          title = 'Calibration Report' + (searchCal !== '' ? ' (Filtered)' : '');
          content = generatePrintTable(['Equipment', 'Serial No', 'Camp', 'Cal. Date', 'Due Date', 'Status'], 
            records.map(i => [i.equipment, i.serial, i.camp || '-', i.calDate, i.dueDate, i.status]));
          break;
      }
      
      printWindow.document.write(`
        <html>
          <head>
            <title>${title}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h1 { color: #1e40af; text-align: center; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background: #1e40af; color: white; }
              @media print { button { display: none; } }
            </style>
          </head>
          <body>
            <h1>${title}</h1>
            <p style="text-align: center; color: #666;">Generated on ${new Date().toLocaleDateString()}</p>
            ${content}
            <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; background: #1e40af; color: white; border: none; border-radius: 5px; cursor: pointer;">Print / Save as PDF</button>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    function generatePrintTable(headers, rows) {
      let html = '<table><thead><tr>';
      headers.forEach(h => html += `<th>${h}</th>`);
      html += '</tr></thead><tbody>';
      
      if (rows.length === 0) {
        html += '<tr><td colspan="' + headers.length + '" style="text-align: center; padding: 40px; color: #999;">No data available</td></tr>';
      } else {
        rows.forEach(row => {
          html += '<tr>';
          row.forEach(cell => html += `<td>${cell || '-'}</td>`);
          html += '</tr>';
        });
      }
      
      html += '</tbody></table>';
      return html;
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ac2123af2a4f9ef',t:'MTc2NTQyNTU4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>